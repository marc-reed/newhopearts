---
import { contentfulClient } from "../lib/contentful";
import { createRenderOptions, createSidebarMarkup } from "../lib/contentful-renderer";
import { documentToHtmlString } from "@contentful/rich-text-html-renderer";
import Layout from '../layouts/Layout.astro';
import type { EntrySkeletonType } from "contentful";

const { slug } = Astro.params;

// Fetch the specific page by slug
const entries = await contentfulClient.getEntries<EntrySkeletonType>({
  content_type: "navbarPages",
  "fields.slug": slug,
});

const page: any = entries.items[0];


// If no page found, return 404
if (!page) {
  return Astro.redirect('/404');
}

const navbarEntries = await contentfulClient.getEntries<EntrySkeletonType>({
  content_type: 'navbarPages',
});

const entryHrefById: Record<string, string> = {};
const mapEntryHref = (entry: any) => {
  if (!entry?.sys?.id || !entry?.fields) return;
  const href = entry.fields.externalLinkUrl || (entry.fields.slug ? `/${entry.fields.slug}` : undefined);
  if (href) {
    entryHrefById[entry.sys.id] = href;
  }
};

navbarEntries.items.forEach((entry: any) => {
  mapEntryHref(entry);
  if (Array.isArray(entry.fields?.childPages)) {
    entry.fields.childPages.forEach((child: any) => mapEntryHref(child));
  }
});

const pageRenderOptions = page.fields.pageContent
  ? await createRenderOptions(page.fields.pageContent, entryHrefById)
  : undefined;
const sidebarMarkup = page.fields.pageContent
  ? await createSidebarMarkup(page.fields.pageContent, entryHrefById)
  : '';

// Generate static paths for all navbar pages
export async function getStaticPaths() {
  const entries = await contentfulClient.getEntries<EntrySkeletonType>({
    content_type: "navbarPages",
  });
  
  // Collect all child page IDs
  const childPageIds = new Set();
  entries.items.forEach((item: any) => {
    if (item.fields.childPages) {
      item.fields.childPages.forEach((child: any) => {
        childPageIds.add(child.sys.id);
      });
    }
  });
  
  return entries.items
    .filter((item: any) => !item.fields.externalLinkUrl) // Only include internal pages
    .map((item: any) => ({
      params: { slug: item.fields.slug },
    }));
}
---

<Layout title={`${page.fields.pageTitle} | New Hope Arts`}>

<div class="container mx-auto mt-4 px-4 sm:px-6 lg:px-8">
	<main>
		<h1>{page.fields.pageTitle}</h1>
    
    {page.fields.pageContent && (
      <div class={sidebarMarkup ? 'nha-page-content-layout' : undefined}>
        <div set:html={documentToHtmlString(page.fields.pageContent, pageRenderOptions)} />
        {sidebarMarkup && <aside class="nha-sidebar-column" set:html={sidebarMarkup} />}
      </div>
    )}
	</main>
	</div>
</Layout>

<style>
  .nha-page-content-layout {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1rem;
  }

  .nha-sidebar-column :global(.nha-sidebar-card) {
    border: 1px solid #d1d5db;
    border-radius: 0.75rem;
    padding: 1rem;
    background: #f8fafc;
    margin-bottom: 1rem;
  }

  @media (min-width: 768px) {
    .nha-page-content-layout {
      grid-template-columns: minmax(0, 2fr) minmax(240px, 1fr);
      align-items: start;
      gap: 1.5rem;
    }
  }
</style>
